**WARNING DEPRECATED METHODS USED IN THIS RG**

- DOM selectors: The functions in this RG use DOM selectors that are subject to change. In production, do not use these functions if your solution is still going to de dependent on the DOM selectors.
  * There is no way of targeting the discount form using a name attribute therefore this customisation is dependant on html generated by a liquid drop that we can no longer support.

## The Problem

A merchant wants to set up discount codes for items in a collection, but they only want the discount codes to be applicable if there is already over a certain dollar amount in the cart.

## The Solution

### Dependencies
This mod requires the [Plus.func](https://github.com/Shopify/plus-theme-support/blob/master/Reference%20Guides/Modifying%20checkout%20and%20Plus.func%20.md) and [jQuery 1.12.0](http://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js).

### Step 1 - Creating the Discount Codes

First up, we create the discount codes:

![https://monosnap.com/file/lQRv93m8rV1i0XyvlTwRD02TTMNLGl.png](https://monosnap.com/file/lQRv93m8rV1i0XyvlTwRD02TTMNLGl.png)

### Step 2 - Creating and Defining Theme Settings and Error Codes

Next up we need to create and define some theme settings to target these new codes and their thresholds. These are defined by a comma separated, colon delimited list of codes and the cents-value of the order price threshold.

```javascript
{
  "name": "Discount thresholds [Plus]",
  "settings": [
    {
      "type": "header",
      "content": "Discount thresholds"
    },
    {
      "type": "checkbox",
      "id": "plus_enable_discount_thresholds",
      "label": "Enable discount thresholds modification",
      "default": true
    },
    {
      "type": "textarea",
      "id": "plus_discount_thresholds",
      "label": "List of discount codes and their order total thresholds (in cents)",
      "info": "Must be comma-separated and delimited with a colon (e.g. 'shopifythreshold:10000,shopifythreshold:20000)"
    },
    {
      "type": "textarea",
      "id": "plus_threshold_error",
      "label": "Threshold error message",
      "info": "Error message when customer's cart total does not meet threshold requirements."
    }
  ]
}
```

![https://monosnap.com/file/95JyU3LMSLLDqUyDSXkHbbFvbuqOvo.png](https://monosnap.com/file/95JyU3LMSLLDqUyDSXkHbbFvbuqOvo.png)

### Step 3 - Customizing checkout.liquid

Firstly, if the `checkout.liquid` layout doesn't exist, create it, then include the following lines, underneath `{{ checkout_scripts }}`

```
{{ 'checkout.scss.css' | asset_url | stylesheet_tag }}
{{ '//ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js' | script_tag }}
{{ 'plus-func.js' | asset_url | script_tag }}
{% include 'plus_checkout_discounts' with settings.plus_enable_discount_thresholds %}
```

You will need to made sure `plus-func.js` has been added to your asset folder from the dependencies listed above.

### Step 4 - Implementing Functionality

Now we add the code. I'm not going to go into too much detail here because you can read code and I can't be bother writing a novel, but basically what we're doing is creating a javascript object array from the theme settings and running a test when a discount code is submitted to make sure that the threshold price is met. If not, we throw an error. In addition we check the validity of existing discount codes to make sure they still apply to the cart, this is done using plus objects.

The best place to put this would be inside of a new snippet, called `plus_checkout_discounts.liquid` for example, which is then called in the `checkout.liquid` file.

```javascript
{% if plus_checkout_discounts %}
<script>
(function($) {
  'use strict';

  $(document).ready(function() {

    // Define global variables
    var checkoutSubtotal = {{ checkout.subtotal_price  }};
    var errorMessage = {{ settings.plus_threshold_error | json }};

    // Define object array of discount codes and price thresholds
    {% assign discount_array = settings.plus_discount_thresholds | strip_newlines | split: ',' %}
    var discountObjArray = [
      {% for d in discount_array %}
      {% assign d_code = d | split: ':' | first %}
      {% assign d_thresh = d | split: ':' | last | plus: 0 %}
      { 
        code:'{{ d_code }}', 
        threshold: {{ d_thresh }}
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    // Run on page load to check if cart contents have changed and if codes still apply
    var discountValidityFn = function() {
      $.each(discountObjArray, function(key, obj) {
        var code = obj.code.toLowerCase();
        var threshold = obj.threshold;
        var appliedCode = $(document).find('.applied-reduction-code__information').first().text().toLowerCase();

        if (code === appliedCode && checkoutSubtotal < threshold) {
          $('.applied-reduction-code__clear-button').click();
          $(document).on('page:load page:change', function() {
            Plus.func('discount-msg', 'discount_form', function() {
              $('input[name="checkout[reduction_code]"]').after('<p class="field__message field__message--custom_error">' + errorMessage + '</p>');
            });
          });
        }
      });
    };

    var discountCheckTriggerFn = function() {
      // Target submit on dynamic discount forms and define variables
      Checkout.$(document).on('submit', '[data-reduction-form] form', function(evt) {
        var discountQualify = true;
        var $discountFormInput = $(this).find('input[name="checkout[reduction_code]"]');
        var appliedCode = $discountFormInput.val();

        // Prevent form submit and check if discount meets threshold
        evt.preventDefault();
        evt.stopPropagation();

        $.each(discountObjArray, function(key, obj) {
          var code = obj.code;
          var threshold = obj.threshold;

          if (code === appliedCode && checkoutSubtotal < threshold) {
            // Discount does not meet threshold
            discountQualify = false;
          }
        });

        // Pass qualification variable and current form object into action function
        discountCheckActionFn(discountQualify, $(this));
      });
    };

    var discountCheckActionFn = function(discountQualify, $discountForm) {
      // If discount qualifies, submit form
      if (discountQualify) {
        $discountForm.submit();
      } else {
        // Throw error message
        if (!$('.field__message--custom_error').length > 0) {
          $discountForm.find('.field').append('<p class="field__message field__message--custom_error">' + errorMessage + '</p>');
        }
      }
    };

    discountValidityFn();
    discountCheckTriggerFn();
 });
})(jQuery);
</script>
{% endif %}
```

### Step 5 - Adding Styles

Because we're creating a new error field, rather than writing over the existing Shopify ones, we're going to need to create a new stylesheet called `checkout.scss.liquid` with the following:

```css
.field__message--custom_error {
  display: block;
  line-height: 1.3em;
  margin: 0.75em 0 0.25em;
  color: {{ settings.checkout_error_color }};
}
```

**FIN**
